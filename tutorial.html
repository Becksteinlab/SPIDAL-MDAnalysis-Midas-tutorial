
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial &#8212; SPIDAL Tutorial: MDAnalysis with Midas 1.2 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="_static/mdanalysis-logo.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Available code" href="code/listings.html" />
    <link rel="prev" title="Data files" href="datafiles.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>We will first test that MDAnalysis can perform PSA, using the small
test set. We will then look in detail into the radical.pilot script
that implements the map-step. Finally, we conclude with the
reduce-step and analysis of the data.</p>
<div class="section" id="preliminary-test">
<h2>Preliminary test<a class="headerlink" href="#preliminary-test" title="Permalink to this headline">¶</a></h2>
<p>Provide topology and trajectory files to the PSA script
<strong class="program">mdanalysis_psa_partial.py</strong> as two lists in a JSON file (see
<a class="reference internal" href="code/mdanalysis_psa_partial.html#mdanalysis-psa-partial"><span class="std std-ref">mdanalysis_psa_partial.py</span></a> for more details). Initially we just
want to check that the script can process the data</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>mdaenv<span class="o">)</span> $ <span class="nv">$RPDIR</span>/mdanalysis_psa_partial.py --inputfile testcase.json -n <span class="m">5</span>
</pre></div>
</div>
<p>This means</p>
<ul class="simple">
<li>use the test case</li>
<li>compare the first 5 trajectories against the remaining 5
trajectories</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">-n</span></code> (split) argument is important because we are going to use
it to decompose the full distance matrix into sub-matrices. (If you
just want to do all-vs-all comparisons, use the
<strong class="program">mdanalysis_psa.py</strong> script.)</p>
<p>You should see output like</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>Loading paths from JSON file testcase.json
Processing 10 trajectories.
Splitting trajectories in two blocks of length 5 and 5
Calculating D (shape 5 x 5) with 25 entries
----------[ TIMING ]--------------------
load Universes                     0.448 s
universe.transfer_to_memory()      0.178 s
PSA distance matrix                1.483 s
saving output                      0.001 s
----------------------------------------
total time                         2.111 s
----------------------------------------
</pre></div>
</div>
<p>This indicates that all MDAnalysis parts are working.</p>
<p>Similarly:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>mdaenv<span class="o">)</span> $ <span class="nv">$RPDIR</span>/mdanalysis_psa_partial.py --inputfile testcase.json -n <span class="m">7</span>
</pre></div>
</div>
<p>should give something like</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>Loading paths from JSON file testcase.json
Processing 10 trajectories.
Splitting trajectories in two blocks of length 7 and 3
Calculating D (shape 7 x 3) with 21 entries
----------[ TIMING ]--------------------
load Universes                     0.422 s
universe.transfer_to_memory()      0.132 s
PSA distance matrix                1.436 s
saving output                      0.001 s
----------------------------------------
total time                         1.991 s
----------------------------------------
</pre></div>
</div>
</div>
<div class="section" id="supercomputer-environment">
<h2>Supercomputer environment<a class="headerlink" href="#supercomputer-environment" title="Permalink to this headline">¶</a></h2>
<p>We used <a class="reference external" href="https://www.tacc.utexas.edu/stampede/">TACC Stampede</a> to
run the calculations on 32 cores but any cluster or even a multi core
workstation might be sufficient.</p>
<ul>
<li><p class="first">Make sure all env vars are set (especially MongoDB,
<span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">RADICAL_PILOT_DBURL</span></code>) and password-less ssh works.</p>
</li>
<li><p class="first">On stampede: Set environment variable  <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">RADICAL_PILOT_PROJECT</span></code> to your
XSEDE allocation:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">RADICAL_PILOT_PROJECT</span><span class="o">=</span>TG-xxxxxx
</pre></div>
</div>
</li>
<li><p class="first">Activate the <em>mdaenv</em> environment.</p>
</li>
<li><p class="first">You should have the JSON files in the <code class="docutils literal"><span class="pre">WORK</span></code> directory.</p>
</li>
</ul>
<p>Copy the two scripts to the WORK directory (at the moment, this is a
limitation of the scripts to keep them simple)L</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> WORK
cp <span class="nv">$RPDIR</span>/<span class="o">{</span>rp_psa.py,mdanalysis_psa_partial.py<span class="o">}</span> .
</pre></div>
</div>
</div>
<div class="section" id="map-step-radical-pilot-script">
<h2>Map-step: Radical.pilot script<a class="headerlink" href="#map-step-radical-pilot-script" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rp-script">
<h3>RP script<a class="headerlink" href="#rp-script" title="Permalink to this headline">¶</a></h3>
<p>The pilot script is <strong class="program">rp/rp_psa.py</strong> (see <a class="reference internal" href="code/rp_psa.html#rp-psa"><span class="std std-ref">rp_psa.py</span></a> for
details). In the following, important parts of the script are
explained.</p>
<p>First, a session is created and a Pilot Manager is initialized:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>65
66
67
68
69
70</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">session</span>   <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">Session</span> <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">session_name</span><span class="p">)</span>
        <span class="n">c</span>         <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">Context</span> <span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_context</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">print</span> <span class="s2">&quot;initialize pilot manager ...&quot;</span>
        <span class="n">pmgr</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">PilotManager</span> <span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Second, a ComputePilot is described and submitted to the Pilot Manager:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>73
74
75
76
77
78
79
80
81
82</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">pdesc</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">ComputePilotDescription</span> <span class="p">()</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="s2">&quot;xsede.stampede&quot;</span>   <span class="c1"># xsede.stampede or xsede.comet or ... check docs!</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">runtime</span>  <span class="o">=</span> <span class="mi">20</span> <span class="c1"># minutes</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">cores</span>    <span class="o">=</span> <span class="n">cores</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">project</span>  <span class="o">=</span> <span class="n">PROJECT</span> <span class="c1">#Project allocation, pass through env var PROJECT</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">cleanup</span>  <span class="o">=</span> <span class="bp">False</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">access_schema</span> <span class="o">=</span> <span class="s1">&#39;ssh&#39;</span>

        <span class="c1"># submit the pilot.</span>
        <span class="n">pilot</span> <span class="o">=</span> <span class="n">pmgr</span><span class="o">.</span><span class="n">submit_pilots</span> <span class="p">(</span><span class="n">pdesc</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>First, a Unit Manager is created for that session and the Pilot is added:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>85
86
87
88</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">umgr</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">UnitManager</span>  <span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">rp</span><span class="o">.</span><span class="n">SCHED_DIRECT_SUBMISSION</span><span class="p">)</span>

        <span class="c1">#add pilot to unit manager</span>
        <span class="n">umgr</span><span class="o">.</span><span class="n">add_pilots</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The script reads the topology and trajectory files from a JSON file:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>91
92</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILELIST</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
            <span class="n">topologies</span><span class="p">,</span> <span class="n">trajectories</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The MDAnalysis script is staged</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 99
100
101
102
103
104
105
106
107
108
109
110
111
112</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">fname_stage</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># stage all files to the staging area</span>
        <span class="n">src_url</span> <span class="o">=</span> <span class="s1">&#39;file://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">)</span>

        <span class="c1">#print src_url</span>

        <span class="n">sd_pilot</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">src_url</span><span class="p">,</span>
                    <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MY_STAGING_AREA</span><span class="p">,</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">),</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">TRANSFER</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">fname_stage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd_pilot</span><span class="p">)</span>

        <span class="c1"># Synchronously stage the data to the pilot</span>
        <span class="n">pilot</span><span class="o">.</span><span class="n">stage_in</span><span class="p">(</span><span class="n">fname_stage</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>In a loop, a CU is set up for each block matrix — this is the
<strong>map</strong> step. In particular, the trajectories are partitioned
according to the <code class="docutils literal"><span class="pre">BLOCK_SIZE</span></code> (the parameter <span class="math">\(w\)</span>) and all
necessary information is written to a JSON file that will be used as
the input for the <strong class="program">mdanalysis_psa_partial.py</strong> script:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">cudesc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">),</span> <span class="n">BLOCK_SIZE</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">),</span> <span class="n">BLOCK_SIZE</span><span class="p">):</span>
                <span class="n">fshared</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">shared</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MY_STAGING_AREA</span><span class="p">,</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">),</span>
                          <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">,</span>
                          <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                <span class="n">fshared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>

                <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                           <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                           <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                              <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]]</span>
                <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">:</span>
                    <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                               <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                               <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                                  <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]]</span>
                    <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
                <span class="c1"># always copy all unique topology files</span>
                <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">topology</span><span class="p">),</span>
                           <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">topology</span><span class="p">),</span>
                           <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                          <span class="k">for</span> <span class="n">topology</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">topologies</span><span class="p">)]</span>
                <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>

<span class="hll">                <span class="c1"># block of topology / trajectory pairs</span>
</span><span class="hll">                <span class="c1">#   block[:nsplit] + block[nsplit:]</span>
</span><span class="hll">                <span class="c1"># The MDA script wants one long list of trajectories and the index nsplit</span>
</span><span class="hll">                <span class="c1"># that indicates where to split the list to create the two groups of</span>
</span><span class="hll">                <span class="c1"># trajectories that are compared against each other.</span>
</span><span class="hll">                <span class="n">block_top</span> <span class="o">=</span> <span class="n">topologies</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span> <span class="o">+</span> <span class="n">topologies</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span>
</span><span class="hll">                <span class="n">block_trj</span> <span class="o">=</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span> <span class="o">+</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span>
</span><span class="hll">                <span class="n">block</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_top</span><span class="p">,</span> <span class="n">block_trj</span><span class="p">]</span>
</span><span class="hll">                <span class="n">nsplit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">])</span>
</span><span class="hll">                <span class="n">imax</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">])</span>
</span><span class="hll">                <span class="n">jmax</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">])</span>
</span><span class="hll">                <span class="c1"># should remember i, imax and j_jmax because we calculate the</span>
</span><span class="hll">                <span class="c1"># submatrix D[i:i+di, j:j+dj] in this CU.</span>
</span><span class="hll">                <span class="n">block_json</span> <span class="o">=</span> <span class="s2">&quot;block-{0}-{1}__{2}-{3}.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="hll">                    <span class="n">i</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span>
</span><span class="hll">                <span class="n">block_matrixfile</span> <span class="o">=</span> <span class="s1">&#39;subdistances_{0}-{1}__{2}-{3}.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class="hll">                    <span class="n">i</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">                <span class="n">manifest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">block_matrixfile</span><span class="p">,</span> <span class="n">block_json</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">imax</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)))</span>
</span><span class="hll">
</span><span class="hll">                <span class="c1"># create input file for the cu and add share it</span>
</span><span class="hll">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">block_json</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
</span><span class="hll">                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">                <span class="c1"># share input json file</span>
</span><span class="hll">                <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">block_json</span><span class="p">)),</span>
</span><span class="hll">                           <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">block_json</span><span class="p">),</span>
</span><span class="hll">                           <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
</span><span class="hll">                <span class="p">]</span>
</span><span class="hll">                <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
</span>
                <span class="c1"># define the compute unit, to compute over the trajectory submatrix</span>
                <span class="c1"># TODO: store the offsets WITH the returned matrix (pkl or arrach archive) instead</span>
                <span class="c1">#       of encoding in filename</span>
                <span class="n">cudesc</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">ComputeUnitDescription</span><span class="p">()</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">executable</span>     <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">pre_exec</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;module load python; source activate mdaenv&quot;</span><span class="p">]</span> <span class="c1">#Only for Stampede and with our conda env</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">input_staging</span>  <span class="o">=</span> <span class="n">fshared</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">output_staging</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">block_matrixfile</span><span class="p">,</span>
                                         <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">block_matrixfile</span><span class="p">,</span>
                                         <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">TRANSFER</span><span class="p">}</span>
<span class="hll">                <span class="n">cudesc</span><span class="o">.</span><span class="n">arguments</span>      <span class="o">=</span> <span class="p">[</span><span class="n">SHARED_MDA_SCRIPT</span><span class="p">,</span> <span class="s1">&#39;--nsplit&#39;</span><span class="p">,</span> <span class="n">nsplit</span><span class="p">,</span>
</span><span class="hll">                                         <span class="s1">&#39;--inputfile&#39;</span><span class="p">,</span> <span class="n">block_json</span><span class="p">,</span>
</span><span class="hll">                                         <span class="s1">&#39;--outfile&#39;</span><span class="p">,</span> <span class="n">block_matrixfile</span><span class="p">,</span> <span class="p">]</span>
</span>                <span class="n">cudesc</span><span class="o">.</span><span class="n">cores</span>          <span class="o">=</span> <span class="mi">1</span>

                <span class="n">cudesc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cudesc</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>For the <a class="reference internal" href="#section-reduce-step"><span class="std std-ref">reduce step</span></a>, all information
about the block matrix (filename and indices in the distance matrix)
are written to a JSON file (“manifest”):</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>193
194</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">MANIFEST_NAME</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Finally, the CUs are submitted to execute on the compute resources and
the script waits until they are all complete:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>197
198
199
200
201
202</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="c1"># submit, run and wait and...</span>
        <span class="c1">#print &quot;submit units to unit manager ...&quot;</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">umgr</span><span class="o">.</span><span class="n">submit_units</span><span class="p">(</span><span class="n">cudesc_list</span><span class="p">)</span>

        <span class="c1">#print &quot;wait for units ...&quot;</span>
        <span class="n">umgr</span><span class="o">.</span><span class="n">wait_units</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="launch-pilot-jobs">
<h3>Launch pilot jobs<a class="headerlink" href="#launch-pilot-jobs" title="Permalink to this headline">¶</a></h3>
<p>Launch the pilot job from the login node of stampede (or the cluster
where you set up your radical.pilot environment):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python rp_psa.py trajectories.json <span class="m">20</span> <span class="m">16</span> SPIDAL.001
</pre></div>
</div>
<p>The <strong class="program">rp_psa.py</strong> radical.pilot script takes as input (see
<a class="reference internal" href="code/rp_psa.html#rp-psa"><span class="std std-ref">rp_psa.py</span></a> for details):</p>
<ul class="simple">
<li>the JSON file with the trajectories (trajectories.json)</li>
<li>number of trajectories per block (20)</li>
<li>number of cores to request (16)</li>
<li>session name (arbitrary string, “SPIDAL.001”); note that you
need to provide a new session name every time you-rerun the command,
e.g. “SPIDAL.002”, “SPIDAL.003”, …</li>
</ul>
</div>
</div>
<div class="section" id="reduce-step">
<span id="section-reduce-step"></span><h2>Reduce-step<a class="headerlink" href="#reduce-step" title="Permalink to this headline">¶</a></h2>
<p>Once the pilot jobs has completed and all block matrices have been
computed we combine all data (<strong>reduce</strong>) into the distance matrix
<span class="math">\(D_{ij}\)</span> and analyze it:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>psa_reduce.py -t trajectories.json -m manifest.json <span class="se">\</span>
              -p psa_plot.pdf -o distance_matrix.npy
</pre></div>
</div>
<div class="section" id="combine-block-matrices">
<h3>Combine block matrices<a class="headerlink" href="#combine-block-matrices" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">manifest.json</span></code> file contains all information that is needed to
re-assemble the distance matrix: for each output file it also stores
the indices of the sub-matrix in the distance matrix and so the full
distance matrix can be built with</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">manifest</span><span class="p">):</span>
    <span class="n">trj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">traj</span><span class="p">))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="hll">    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">manifest</span><span class="p">))</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subD</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">),</span> <span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">j1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mf</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
<span class="hll">            <span class="n">D</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span> <span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">subD</span><span class="p">)</span>
</span><span class="hll">            <span class="n">D</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">,</span> <span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span> <span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span>        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subD</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Missing data: output files</span><span class="se">\n</span><span class="s2">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="s2">&quot;could not be found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">D</span>
</pre></div>
</td></tr></table></div>
<p>The matrix is written to a numpy file <code class="docutils literal"><span class="pre">distance_matrix.npy</span></code> (and can
be loaded with <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.load.html#numpy.load" title="(in NumPy v1.13)"><code class="xref py py-func docutils literal"><span class="pre">numpy.load()</span></code></a>).</p>
</div>
<div class="section" id="analysis">
<h3>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h3>
<p>The distance matrix can be clustered to reveal patterns in the
trajectories. Here we use hierarchical clustering with <a class="reference external" href="https://en.wikipedia.org/wiki/Ward's_method">Ward’s linkage
criterion</a> as implemented in <code class="xref py py-mod docutils literal"><span class="pre">scipy.cluster.hierarchy</span></code>
<a class="reference internal" href="references.html#seyler2015" id="id1">[Seyler2015]</a>. The clustering and plotting code was taken from the
<a class="reference external" href="http://www.mdanalysis.org/docs/documentation_pages/analysis/psa.html#MDAnalysis.analysis.psa.PSAnalysis.cluster" title="(in MDAnalysis v0.16)"><code class="xref py py-meth docutils literal"><span class="pre">cluster()</span></code></a> and
<a class="reference external" href="http://www.mdanalysis.org/docs/documentation_pages/analysis/psa.html#MDAnalysis.analysis.psa.PSAnalysis.plot" title="(in MDAnalysis v0.16)"><code class="xref py py-meth docutils literal"><span class="pre">plot()</span></code></a> methods of
<a class="reference external" href="http://www.mdanalysis.org/docs/documentation_pages/analysis/psa.html#MDAnalysis.analysis.psa.PSAnalysis" title="(in MDAnalysis v0.16)"><code class="xref py py-class docutils literal"><span class="pre">PSAnalysis</span></code></a>. The plotting code is
fairly complicated but the clustering is straightforward:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="n">distArray</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">,</span> <span class="n">count_sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">distance_sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">no_plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">no_labels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">color_threshold</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cluster trajectories and optionally plot the dendrogram.</span>

<span class="sd">    :Arguments:</span>
<span class="sd">      *method*</span>
<span class="sd">        string, name of linkage criterion for clustering [``&#39;ward&#39;``]</span>
<span class="sd">      *no_plot*</span>
<span class="sd">        boolean, if ``True``, do not render the dendrogram [``False``]</span>
<span class="sd">      *no_labels*</span>
<span class="sd">        boolean, if ``True`` then do not label dendrogram [``True``]</span>
<span class="sd">      *color_threshold*</span>
<span class="sd">        For brevity, let t be the color_threshold. Colors all the</span>
<span class="sd">        descendent links below a cluster node k the same color if k is</span>
<span class="sd">        the first node below the cut threshold t. All links connecting</span>
<span class="sd">        nodes with distances greater than or equal to the threshold are</span>
<span class="sd">        colored blue. If t is less than or equal to zero, all nodes are</span>
<span class="sd">        colored blue. If color_threshold is None or ‘default’,</span>
<span class="sd">        corresponding with MATLAB(TM) behavior, the threshold is set to</span>
<span class="sd">        0.7*max(Z[:,2]). [``4``]]</span>
<span class="sd">    :Returns:</span>
<span class="sd">      list of indices representing the row-wise order of the objects</span>
<span class="sd">      after clustering</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">distArray</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="n">dgram</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span>
        <span class="n">Z</span><span class="p">,</span> <span class="n">no_labels</span><span class="o">=</span><span class="n">no_labels</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">count_sort</span><span class="o">=</span><span class="n">count_sort</span><span class="p">,</span> <span class="n">distance_sort</span><span class="o">=</span><span class="n">distance_sort</span><span class="p">,</span>
        <span class="n">no_plot</span><span class="o">=</span><span class="n">no_plot</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="n">color_threshold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Z</span><span class="p">,</span> <span class="n">dgram</span>
</pre></div>
</td></tr></table></div>
<p>In the resulting plot we indicate FRODA trajectories with a heavy
double-bar and DIMS trajectories with a thin single bar.</p>
<div class="figure" id="id3">
<span id="figure-psa"></span><img alt="Clustered PSA distance matrix" src="_images/psa_distance_matrix.png" />
<p class="caption"><span class="caption-text"><strong>PSA of AdK transitions</strong>. Transitions of AdK from the closed to
the open conformation were generated with the DIMS MD and the FRODA
method. <em>Path similarity analysis</em> (PSA) was performed by
hierarchically clustering the matrix of Fréchet distances between
all trajectories, using <a class="reference external" href="https://en.wikipedia.org/wiki/Ward's_method">Ward’s linkage criterion</a>.</span></p>
<div class="legend">
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Symbol</th>
<th class="head">Method</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><cite>||</cite></td>
<td>FRODA</td>
</tr>
<tr class="row-odd"><td><cite>|</cite></td>
<td>DIMS</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Figure <a class="reference internal" href="#figure-psa"><span class="std std-ref">PSA of AdK transitions</span></a> shows clearly that DIMS and FRODA transitions
are different from each other. Each method produces transitions that
are characteristic of the method itself. In a comparison of many different
transition path sampling methods it was also found that this pattern
generally holds, which indicates that there is likely no “best” method
yet <a class="reference internal" href="references.html#seyler2015" id="id2">[Seyler2015]</a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logos/mdanalysistutorial-logo-200x150.png" alt="Logo"/>
    
  </a>
</p>










<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="datafiles.html">Data files</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="code/listings.html">Available code</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="http://spidal.org">SPIDAL</a></li>
    
    <li class="toctree-l1"><a href="http://mdanalysis.org">MDAnalysis</a></li>
    
    <li class="toctree-l1"><a href="https://radical-cybertools.github.io/">Radical Cybertools</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="datafiles.html" title="previous chapter">Data files</a></li>
      <li>Next: <a href="code/listings.html" title="next chapter">Available code</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Oliver Beckstein, Ioannis Paraskevakos, Sean Seyler, Andre Merzky, Andre Luckow, Shantenu Jha.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/tutorial.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/MDAnalysis/mdanalysis" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>