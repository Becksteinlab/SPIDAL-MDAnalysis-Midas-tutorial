<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>rp_psa.py &#8212; SPIDAL Tutorial: MDAnalysis with Midas 1.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/mdanalysis-logo.ico"/>
    <link rel="top" title="SPIDAL Tutorial: MDAnalysis with Midas 1.1 documentation" href="../index.html" />
    <link rel="up" title="Available code" href="listings.html" />
    <link rel="next" title="mdanalysis_psa_partial.py" href="mdanalysis_psa_partial.html" />
    <link rel="prev" title="Available code" href="listings.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="rp-psa-py">
<h1>rp_psa.py<a class="headerlink" href="#rp-psa-py" title="Permalink to this headline">Â¶</a></h1>
<p>The <code class="file docutils literal"><span class="pre">r/rp_psa.py</span></code> script sets up and executes the radical.pilot
job. It implements the <em>map</em> logic and splits the distance matrix
computation into sub-blocks (one block per compute unit). It uses
<a class="reference internal" href="mdanalysis_psa_partial.html"><span class="doc">mdanalysis_psa_partial.py</span></a> to perform the calculation. Importantly,
it generates a JSON file with the &#8220;key/value&#8221; pairs (indices into the
full PSA distance matrix/filenames of the sub-block matrices) that are
necessary for the <em>reduce</em> step that is performed with
<a class="reference internal" href="psa_reduce.html"><span class="doc">psa_reduce.py</span></a>.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># radical.pilot script to run MDAnalysis Path Similarity Analysis</span>
<span class="c1">#</span>
<span class="c1"># =======================================</span>
<span class="c1"># configured for XSEDE TACC stampede</span>
<span class="c1"># =======================================</span>
<span class="c1">#</span>
<span class="c1"># USAGE: python rp_psa.py trajectories.json &lt;blocksize&gt; &lt;cores&gt; &lt;session-name&gt;</span>
<span class="c1">#</span>
<span class="c1"># ENVIRONMENT VARIABLES must be set:</span>
<span class="c1">#</span>
<span class="c1">#   export RADICAL_PILOT_PROJECT=TG-xxxxxx</span>
<span class="c1">#   export RADICAL_PILOT_DBURL=&quot;mongodb://user:pass@host:port/dbname&quot;</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Provide a JSON file with two lists of files:</span>
<span class="c1">#</span>
<span class="c1"># [</span>
<span class="c1">#  [topol1, topol1, topol1, ..., topol2, ...],</span>
<span class="c1">#  [trj1, trj2, trj3, ...]</span>
<span class="c1"># ]</span>
<span class="c1">#</span>
<span class="c1"># where each trj file name has a corresponding topology filename;</span>
<span class="c1"># the topology filenames can (and should) be repeated as often as</span>
<span class="c1"># necessary.</span>
<span class="c1">#</span>
<span class="c1"># The entries must be absolute paths.</span>
<span class="c1">#</span>
<span class="c1"># For this example, no additional superposition is performed and</span>
<span class="c1"># the trajectories are used as is. CA atoms are selected.</span>
<span class="c1">#</span>
<span class="c1"># The Frechet distance matrix between ALL trajectories (all-vs-all)</span>
<span class="c1"># is calculated.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;RADICAL_PILOT_VERBOSE&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span>
<span class="c1"># os.environ[&#39;RADICAL_PILOT_LOG_TGT&#39;]=&#39;/tmp/rp.log&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">radical.pilot</span> <span class="kn">as</span> <span class="nn">rp</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="c1">#----------------------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">MY_STAGING_AREA</span> <span class="o">=</span> <span class="s1">&#39;staging:///&#39;</span>
    <span class="n">SHARED_MDA_SCRIPT</span> <span class="o">=</span> <span class="s1">&#39;mdanalysis_psa_partial.py&#39;</span>
    <span class="n">FILELIST</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">session_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">MANIFEST_NAME</span> <span class="o">=</span> <span class="s2">&quot;manifest.json&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">PROJECT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;RADICAL_PILOT_PROJECT&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PROJECT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Set RADICAL_PILOT_PROJECT to your XSEDE allocation&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span>   <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">Session</span> <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">session_name</span><span class="p">)</span>
        <span class="n">c</span>         <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">Context</span> <span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_context</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">print</span> <span class="s2">&quot;initialize pilot manager ...&quot;</span>
        <span class="n">pmgr</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">PilotManager</span> <span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="c1">#pmgr.register_callback (pilot_state_cb)</span>

        <span class="n">pdesc</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">ComputePilotDescription</span> <span class="p">()</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="s2">&quot;xsede.stampede&quot;</span>   <span class="c1"># xsede.stampede or xsede.comet or ... check docs!</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">runtime</span>  <span class="o">=</span> <span class="mi">20</span> <span class="c1"># minutes</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">cores</span>    <span class="o">=</span> <span class="n">cores</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">project</span>  <span class="o">=</span> <span class="n">PROJECT</span> <span class="c1">#Project allocation, pass through env var PROJECT</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">cleanup</span>  <span class="o">=</span> <span class="bp">False</span>
        <span class="n">pdesc</span><span class="o">.</span><span class="n">access_schema</span> <span class="o">=</span> <span class="s1">&#39;ssh&#39;</span>

        <span class="c1"># submit the pilot.</span>
        <span class="n">pilot</span> <span class="o">=</span> <span class="n">pmgr</span><span class="o">.</span><span class="n">submit_pilots</span> <span class="p">(</span><span class="n">pdesc</span><span class="p">)</span>

        <span class="c1">#initialize unit manager</span>
        <span class="n">umgr</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">UnitManager</span>  <span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">rp</span><span class="o">.</span><span class="n">SCHED_DIRECT_SUBMISSION</span><span class="p">)</span>

        <span class="c1">#add pilot to unit manager</span>
        <span class="n">umgr</span><span class="o">.</span><span class="n">add_pilots</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span>

        <span class="c1"># get ALL topology and trajectory files</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILELIST</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
            <span class="n">topologies</span><span class="p">,</span> <span class="n">trajectories</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

        <span class="c1"># list of outputfiles &lt;--&gt; submatrix indices</span>
        <span class="c1"># (built during CU creation)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fshared_list</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fname_stage</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># stage all files to the staging area</span>
        <span class="n">src_url</span> <span class="o">=</span> <span class="s1">&#39;file://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">)</span>

        <span class="c1">#print src_url</span>

        <span class="n">sd_pilot</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">src_url</span><span class="p">,</span>
                    <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MY_STAGING_AREA</span><span class="p">,</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">),</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">TRANSFER</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">fname_stage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd_pilot</span><span class="p">)</span>

        <span class="c1"># Synchronously stage the data to the pilot</span>
        <span class="n">pilot</span><span class="o">.</span><span class="n">stage_in</span><span class="p">(</span><span class="n">fname_stage</span><span class="p">)</span>

        <span class="c1"># we create one CU for a block of the distance matrix</span>
        <span class="n">cudesc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">),</span> <span class="n">BLOCK_SIZE</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">),</span> <span class="n">BLOCK_SIZE</span><span class="p">):</span>
                <span class="n">fshared</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">shared</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MY_STAGING_AREA</span><span class="p">,</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">),</span>
                          <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">SHARED_MDA_SCRIPT</span><span class="p">,</span>
                          <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                <span class="n">fshared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>

                <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                           <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                           <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                              <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]]</span>
                <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">:</span>
                    <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                               <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">trajectory</span><span class="p">),</span>
                               <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                                  <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]]</span>
                    <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
                <span class="c1"># always copy all unique topology files</span>
                <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">topology</span><span class="p">),</span>
                           <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">topology</span><span class="p">),</span>
                           <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                          <span class="k">for</span> <span class="n">topology</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">topologies</span><span class="p">)]</span>
                <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>

                <span class="c1"># block of topology / trajectory pairs</span>
                <span class="c1">#   block[:nsplit] + block[nsplit:]</span>
                <span class="c1"># The MDA script wants one long list of trajectories and the index nsplit</span>
                <span class="c1"># that indicates where to split the list to create the two groups of</span>
                <span class="c1"># trajectories that are compared against each other.</span>
                <span class="n">block_top</span> <span class="o">=</span> <span class="n">topologies</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span> <span class="o">+</span> <span class="n">topologies</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span>
                <span class="n">block_trj</span> <span class="o">=</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span> <span class="o">+</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">]</span>
                <span class="n">block</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_top</span><span class="p">,</span> <span class="n">block_trj</span><span class="p">]</span>
                <span class="n">nsplit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">])</span>
                <span class="n">imax</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">])</span>
                <span class="n">jmax</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">])</span>
                <span class="c1"># should remember i, imax and j_jmax because we calculate the</span>
                <span class="c1"># submatrix D[i:i+di, j:j+dj] in this CU.</span>
                <span class="n">block_json</span> <span class="o">=</span> <span class="s2">&quot;block-{0}-{1}__{2}-{3}.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span>
                <span class="n">block_matrixfile</span> <span class="o">=</span> <span class="s1">&#39;subdistances_{0}-{1}__{2}-{3}.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span>

                <span class="n">manifest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">block_matrixfile</span><span class="p">,</span> <span class="n">block_json</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">imax</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)))</span>

                <span class="c1"># create input file for the cu and add share it</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">block_json</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

                <span class="c1"># share input json file</span>
                <span class="n">shared</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;file://{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">block_json</span><span class="p">)),</span>
                           <span class="s1">&#39;target&#39;</span> <span class="p">:</span> <span class="n">basename</span><span class="p">(</span><span class="n">block_json</span><span class="p">),</span>
                           <span class="s1">&#39;action&#39;</span> <span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">LINK</span><span class="p">}</span>
                <span class="p">]</span>
                <span class="n">fshared</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>

                <span class="c1"># define the compute unit, to compute over the trajectory submatrix</span>
                <span class="c1"># TODO: store the offsets WITH the returned matrix (pkl or arrach archive) instead</span>
                <span class="c1">#       of encoding in filename</span>
                <span class="n">cudesc</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">ComputeUnitDescription</span><span class="p">()</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">executable</span>     <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">pre_exec</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;module load python; source activate mdaenv&quot;</span><span class="p">]</span> <span class="c1">#Only for Stampede and with our conda env</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">input_staging</span>  <span class="o">=</span> <span class="n">fshared</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">output_staging</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">block_matrixfile</span><span class="p">,</span>
                                         <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">block_matrixfile</span><span class="p">,</span>
                                         <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">rp</span><span class="o">.</span><span class="n">TRANSFER</span><span class="p">}</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">arguments</span>      <span class="o">=</span> <span class="p">[</span><span class="n">SHARED_MDA_SCRIPT</span><span class="p">,</span> <span class="s1">&#39;--nsplit&#39;</span><span class="p">,</span> <span class="n">nsplit</span><span class="p">,</span>
                                         <span class="s1">&#39;--inputfile&#39;</span><span class="p">,</span> <span class="n">block_json</span><span class="p">,</span>
                                         <span class="s1">&#39;--outfile&#39;</span><span class="p">,</span> <span class="n">block_matrixfile</span><span class="p">,</span> <span class="p">]</span>
                <span class="n">cudesc</span><span class="o">.</span><span class="n">cores</span>          <span class="o">=</span> <span class="mi">1</span>

                <span class="n">cudesc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cudesc</span><span class="p">)</span>

        <span class="c1"># write manifest json file: use it later to piece submatrices back</span>
        <span class="c1"># together</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">MANIFEST_NAME</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Created manifest &#39;{0}&#39;: (block_D, block_trj, (i, i+w), (j, j+w))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MANIFEST_NAME</span><span class="p">))</span>

        <span class="c1"># submit, run and wait and...</span>
        <span class="c1">#print &quot;submit units to unit manager ...&quot;</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">umgr</span><span class="o">.</span><span class="n">submit_units</span><span class="p">(</span><span class="n">cudesc_list</span><span class="p">)</span>

        <span class="c1">#print &quot;wait for units ...&quot;</span>
        <span class="n">umgr</span><span class="o">.</span><span class="n">wait_units</span><span class="p">()</span>

        <span class="k">print</span> <span class="s2">&quot;Creating Profile&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;{0}.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">name</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ProfFile</span><span class="p">:</span>
            <span class="n">ProfFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;CU,New,StageIn,Allocate,Exec,StageOut,Done</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cu</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
                <span class="n">timing_str</span><span class="o">=</span><span class="p">[</span><span class="n">cu</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">cu</span><span class="o">.</span><span class="n">state_history</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Scheduling&#39;</span><span class="p">:</span>
                        <span class="n">timing_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pilot</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;AgentStagingInput&#39;</span><span class="p">:</span>
                        <span class="n">timing_str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pilot</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Allocating&#39;</span><span class="p">:</span>
                        <span class="n">timing_str</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pilot</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Executing&#39;</span><span class="p">:</span>
                        <span class="n">timing_str</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pilot</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;AgentStagingOutput&#39;</span><span class="p">:</span>
                        <span class="n">timing_str</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pilot</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Done&#39;</span><span class="p">:</span>
                        <span class="n">timing_str</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pilot</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

                <span class="n">ProfFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">timing_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="n">timing_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span>
                               <span class="n">timing_str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="n">timing_str</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span>
                               <span class="n">timing_str</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="n">timing_str</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span>
                               <span class="n">timing_str</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># the callback called sys.exit(), and we can here catch the</span>
        <span class="c1"># corresponding KeyboardInterrupt exception for shutdown.  We also catch</span>
        <span class="c1"># SystemExit (which gets raised if the main threads exits for some other</span>
        <span class="c1"># reason).</span>
        <span class="k">print</span> <span class="s2">&quot;need to exit now: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Something unexpected happened in the pilot code above</span>
        <span class="k">print</span> <span class="s2">&quot;caught Exception: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
        <span class="k">raise</span>

    <span class="k">finally</span> <span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;Closing session, exiting now ...&quot;</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">cleanup</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</pre></div>
</td></tr></table></div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logos/mdanalysistutorial-logo-200x150.png" alt="Logo"/>
    
  </a>
</p>










<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datafiles.html">Data files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="listings.html">Available code</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="listings.html#map-reduce-scripts">Map-reduce scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="listings.html#helper-scripts">Helper scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="http://spidal.org">SPIDAL</a></li>
    
    <li class="toctree-l1"><a href="http://mdanalysis.org">MDAnalysis</a></li>
    
    <li class="toctree-l1"><a href="https://radical-cybertools.github.io/">Radical Cybertools</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="listings.html">Available code</a><ul>
      <li>Previous: <a href="listings.html" title="previous chapter">Available code</a></li>
      <li>Next: <a href="mdanalysis_psa_partial.html" title="next chapter">mdanalysis_psa_partial.py</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Oliver Beckstein, Ioannis Paraskevakos, Sean Seyler, Andre Merzky, Andre Luckow, Shantenu Jha.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/code/rp_psa.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/MDAnalysis/mdanalysis" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>